$acclist = @("jmoney", "plinktern") | ForEach-Object { $_.Trim().ToLower() }

# Get all AD users (enabled or disabled), convert names to lowercase
$acc = Get-ADUser -Filter * -Properties SamAccountName |
        Select-Object -ExpandProperty SamAccountName |
        ForEach-Object { $_.Trim().ToLower() }

foreach ($user in $acc) {
    if ($user -notin $acclist) {
        Disable-ADAccount -Identity $user
        Write-Host "Disabled AD account: $user"
    }
}


try {
    # Find the real krbtgt DN
    $krb = Get-ADUser -Filter { SamAccountName -eq "krbtgt" } -Properties userAccountControl
    $dn = $krb.DistinguishedName

    Write-Host "Found krbtgt at: $dn"

    # Bind directly with ADSI (bypasses built-in account restrictions)
    $adsi = [ADSI]("LDAP://" + $dn)

    # Get current UAC
    $uac = $adsi.userAccountControl[0]
    $newUac = $uac -band (-bnot 2)  # Clear the disable bit

    # Apply change
    $adsi.userAccountControl = $newUac
    $adsi.CommitChanges()

    Write-Host "SUCCESS: krbtgt has been re-enabled."
}
catch {
    Write-Host "ERROR:" $_
}
